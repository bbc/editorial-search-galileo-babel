#!/usr/bin/env groovy
@org.jenkinsci.plugins.workflow.libs.Library('isite-jenkins-libs')
import bbc.isite.jenkinslibs.git.GithubNotifier

pipeline {
    agent { label '!forge' }
     
    parameters {
        string(defaultValue: '20', description:'The version to deploy it must be unique", name: 'cosmosVersion')
    }

    options {
        timeout(time: 1, unit: 'HOURS')
        timestamps()
    }
    stages {
        stage('Build') {
            steps {
                checkout scm
                script {
                    new GithubNotifier().notifyGithubPending();
                }
                sh 'rm -rf GalileoBabel.zip'
		sh 'zip GalileoBabel.zip galileo_babel_s3.py'
            }
        }
        stage('Release') {
            steps {
                sh "cosmos-release lambda --lambda-version=${params.cosmosVersion} GalileoBabel.zip editorial-search-galileo-babel"
            }
        }
        stage('Deploy') {
            steps {
                sh "cosmos deploy-lambda -f editorial-search-galileo-babel int ${params.cosmosVersion}"
            }
        }
    }
  	post {
  		success {
  			script { new GithubNotifier().notifyGithubSuccess(); }
  		}
  		failure {
  			script { new GithubNotifier().notifyGithubFailure(); }
  		}
  	}
}
